<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FqEMS</title>
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>
  <style>
    :root { --accent: #5B7C99; --bg: #F8F9FA; --card-bg: #ffffff; --text: #0f172a; --border: #E0E0E0; }
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 100vw; overflow-x: hidden; }
    header { background: var(--card-bg); border-bottom: 1px solid var(--border); }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h1 { margin: 0; padding: 16px 0; color: var(--accent); font-weight: 300; letter-spacing: 0.5px; font-size: 1.8rem; }
    .main-container { width: 100%; max-width: 800px; margin: auto; display: flex; flex-direction: column; gap: 2rem; }
    .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .btn { display: inline-block; padding: 10px 14px; border-radius: 10px; border: 1px solid var(--accent); color: #fff; background: var(--accent); cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.12); transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease; }
    .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.12); }
    .btn-outline { background: transparent; color: var(--accent); }
    a.btn-outline { text-decoration: none; }
    a.btn-outline:hover { background: rgba(91,124,153,0.08); }
    .input, .select { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 10px; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
    .input:hover, .select:hover { box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .chart-box { width: 100%; min-height: 400px; }
    .graph-container { width: 100%; min-height: 400px; }
    .scroll-x { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid var(--border); padding: 12px 14px; font-size: 14px; }
    thead th { background: #F5F5F5; font-weight: 500; }
    tbody tr:nth-child(odd) { background: #FAFAFA; }
    .gallery { display: flex; flex-direction: column; gap: 1rem; }
    .image-item { display: flex; flex-direction: column; gap: 0.5rem; }
    .image-item img { width: 100%; border: 1px solid var(--border); border-radius: 10px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div style="display:flex; align-items:center; justify-content:space-between;">
        <h1>IDSE Project - FqEMS</h1>
      </div>
    </div>
  </header>
  
  <main class="wrap">
    <div class="main-container">
      <div class="card">
        <h3>Upload Data</h3>
        <form id="upload-form">
          <input class="input" type="file" name="files" accept=".xlsx,.xls,.csv" multiple required />
          <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
            <label>Mode</label>
            <select class="select" name="mode">
              <option value="stack">Stack</option>
              <option value="overwrite">Overwrite</option>
            </select>
          </div>
          <div style="margin-top:10px; display:flex; gap:8px;">
            <button class="btn" type="submit">Upload & Process</button>
            <button id="process-btn" class="btn btn-outline" type="button">Process</button>
            <a class="btn btn-outline" href="/api/export/master.csv">Download CSV</a>
            <button id="reset-btn" class="btn btn-outline" type="button">Reset</button>
          </div>
          <div id="messages" class="alert alert-info" style="display:none;"></div>
        </form>
      </div>
      <div class="card">
        <h3>EDA Summary</h3>
        <div class="scroll-x">
          <h4>Raw CSV EDA</h4>
          <p id="eda-status-raw">Loading…</p>
          <table id="eda-table-raw"></table>
          <h4 style="margin-top:1rem;">Engineered Feature EDA</h4>
          <p id="eda-status-eng">Loading…</p>
          <table id="eda-table-eng"></table>
        </div>
      </div>
      <div class="card">
        <h3>Custom Chart</h3>
        <div style="display:flex; flex-direction: column; gap: 8px;">
          <label>X Axis</label>
          <select id="custom-x" class="select"></select>
          <label>Y Axis</label>
          <select id="custom-y" class="select"></select>
          <label>Chart Type</label>
          <select id="custom-type" class="select">
            <option value="scatter">Scatter</option>
            <option value="line">Line</option>
            <option value="bar">Bar</option>
            <option value="histogram">Histogram</option>
          </select>
          <div>
            <button id="custom-render" class="btn" type="button">Render</button>
          </div>
        </div>
        <div id="chart-custom" class="graph-container chart-box"></div>
      </div>
      <div class="card">
        <h3>Columns</h3>
        <div class="scroll-x">
          <table id="columns-table"></table>
        </div>
      </div>
      <div class="card">
        <h3>Generated Images</h3>
        <div id="images" class="gallery"></div>
      </div>
      <div class="card">
        <h3>Credits</h3>
        <p>IDSE FqEMS Project of ME23B1001 Diwaakar J & ME23B1080 Divyaa Darshini S</p>
        <p>Made with: GCR study materials, GeeksforGeeks, Stackoverflow, TRAE ai, ChatGPT</p>
      </div>
    </div>
  </main>

  <script>
  const messages = document.getElementById('messages');
  const edaTableRaw = document.getElementById('eda-table-raw');
  const edaStatusRaw = document.getElementById('eda-status-raw');
  const edaTableEng = document.getElementById('eda-table-eng');
  const edaStatusEng = document.getElementById('eda-status-eng');
  const uploadForm = document.getElementById('upload-form');
  const processBtn = document.getElementById('process-btn');
  const customX = document.getElementById('custom-x');
  const customY = document.getElementById('custom-y');
  const customType = document.getElementById('custom-type');
  const customRender = document.getElementById('custom-render');
  const columnsTable = document.getElementById('columns-table');
  const images = document.getElementById('images');
  const resetBtn = document.getElementById('reset-btn');

  let fullRecords = [];
  let fullColumns = [];

  const showMessage = (text, kind) => {
    messages.style.display = 'block';
    messages.className = 'alert ' + (kind === 'danger' ? 'alert-danger' : kind === 'success' ? 'alert-success' : 'alert-info');
    messages.textContent = text;
  };

  const renderEDATableRaw = (summary) => {
    edaTableRaw.innerHTML = '';
    const headRows = summary.head || [];
    if (!headRows.length) { edaStatusRaw.textContent = 'No data available.'; return; }
    edaStatusRaw.textContent = '';
    const columns = Object.keys(headRows[0]);
    const thead = document.createElement('thead');
    const trHead = document.createElement('tr');
    columns.forEach(c => { const th = document.createElement('th'); th.textContent = c; trHead.appendChild(th); });
    thead.appendChild(trHead);
    edaTableRaw.appendChild(thead);
    const tbody = document.createElement('tbody');
    headRows.forEach(row => { const tr = document.createElement('tr'); columns.forEach(col => { const td = document.createElement('td'); td.textContent = row[col]; tr.appendChild(td); }); tbody.appendChild(tr); });
    edaTableRaw.appendChild(tbody);
  };

  const renderColumnsTable = (columns, dtypes) => {
    const thead = '<thead><tr><th>Column</th><th>Type</th></tr></thead>';
    const rows = columns.map(c => `<tr><td>${c}</td><td>${dtypes[c]||''}</td></tr>`).join('');
    columnsTable.innerHTML = thead + '<tbody>' + rows + '</tbody>';
  };

  const loadEDARaw = async () => {
    try { const res = await fetch('/api/eda_raw'); const data = await res.json(); if (data.status === 'success') { renderEDATableRaw(data.summary); renderColumnsTable(data.summary.columns || [], data.summary.dtypes || {}); } else { edaStatusRaw.textContent = data.message || 'No data found.'; } } catch { edaStatusRaw.textContent = 'Failed to load raw EDA.'; }
  };

  const renderEDATableEng = (features) => {
    const statRows = [];
    if (features.usage_stats) {
      const s = features.usage_stats;
      statRows.push(`<tr><td>Mean</td><td>${s.mean??''}</td></tr>`);
      statRows.push(`<tr><td>Median</td><td>${s.median??''}</td></tr>`);
      statRows.push(`<tr><td>Std</td><td>${s.std??''}</td></tr>`);
    }
    const countTable = (obj) => {
      if (!obj) return '';
      const keys = Object.keys(obj);
      return '<table style="width:100%"><thead><tr><th>Category</th><th>Count</th></tr></thead><tbody>' + keys.map(k => `<tr><td>${k}</td><td>${obj[k]}</td></tr>`).join('') + '</tbody></table>';
    };
    const monthTable = (arr, label) => {
      if (!arr || !arr.length) return '';
      return '<table style="width:100%"><thead><tr><th>'+label+'</th><th>Units</th></tr></thead><tbody>' + arr.map(r => `<tr><td>${r.month}</td><td>${r.units}</td></tr>`).join('') + '</tbody></table>';
    };
    const facultyTable = (arr) => {
      if (!arr || !arr.length) return '';
      return '<table style="width:100%"><thead><tr><th>Faculty</th><th>Units Mean</th><th>Cost Mean</th></tr></thead><tbody>' + arr.map(r => `<tr><td>${r.faculty}</td><td>${r.units_mean}</td><td>${r.cost_mean}</td></tr>`).join('') + '</tbody></table>';
    };
    const corr = features.correlation_reading_cost;
    const outCount = features.outliers ? features.outliers.count : 0;
    const html = [
      '<h4>Usage Statistics</h4>',
      '<table style="width:100%"><thead><tr><th>Metric</th><th>Value</th></tr></thead><tbody>'+statRows.join('')+'</tbody></table>',
      '<h4 style="margin-top:1rem;">Usage Bin Counts</h4>',
      countTable(features.usage_bin_counts),
      '<h4 style="margin-top:1rem;">Encoded Bin Counts</h4>',
      countTable(features.usage_bin_encoded_counts),
      '<h4 style="margin-top:1rem;">Units Log Counts</h4>',
      countTable(features.units_log_counts),
      '<h4 style="margin-top:1rem;">Outliers</h4>',
      '<p>Count: '+outCount+'</p>',
      '<h4 style="margin-top:1rem;">Correlation</h4>',
      '<p>Reading vs Cost: '+(corr===null||corr===undefined?'':corr.toFixed ? corr.toFixed(3) : corr)+'</p>',
      '<h4 style="margin-top:1rem;">Monthly Trend</h4>',
      monthTable(features.monthly_trend, 'Month'),
      '<h4 style="margin-top:1rem;">Seasonal Trend</h4>',
      monthTable(features.seasonal_trend, 'Month'),
      '<h4 style="margin-top:1rem;">Faculty Comparison</h4>',
      facultyTable((features.faculty_comparison||[]).slice(0,10)),
    ].join('');
    edaTableEng.innerHTML = html;
  };

  const loadEDAEngineered = async () => {
    try { const res = await fetch('/api/eda_engineered'); const data = await res.json(); if (data.status === 'success') { renderEDATableEng(data.features || {}); } else { edaStatusEng.textContent = data.message || 'No data found.'; } } catch { edaStatusEng.textContent = 'Failed to load engineered EDA.'; }
  };

  const fetchMasterFull = async () => {
    try { const res = await fetch('/api/master_full'); const data = await res.json(); if (data.status === 'success') { fullRecords = data.records || []; fullColumns = data.columns || []; setupCustomSelectors(fullColumns); renderCustomChart(); } } catch {}
  };

  const setupCustomSelectors = (columns) => {
    customX.innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join('');
    customY.innerHTML = columns.map(c => `<option value="${c}">${c}</option>`).join('');
    const defaultX = columns.find(c => c.toLowerCase().includes('date')) || columns[0] || '';
    const defaultY = columns.find(c => isNumericCol(c)) || columns[0] || '';
    customX.value = defaultX; customY.value = defaultY;
  };

  const isNumericCol = (col) => {
    for (let i=0;i<fullRecords.length && i<20;i++){ const v = fullRecords[i][col]; if (v!==undefined && v!==null && v!==''){ const n = Number(v); if (!isNaN(n)) return true; } }
    return false;
  };

  const renderCustomChart = () => {
    if (!fullRecords.length || !fullColumns.length) { Plotly.newPlot('chart-custom', [], {title:'Custom Chart', paper_bgcolor:'#fff', plot_bgcolor:'#fff'}); return; }
    const xCol = customX.value; const yCol = customY.value; const type = customType.value;
    const x = fullRecords.map(r => r[xCol]); const y = fullRecords.map(r => Number(r[yCol]));
    const config = {responsive: true};
    if (type === 'histogram') { Plotly.newPlot('chart-custom', [{ x, type: 'histogram', marker:{color:'#7c3aed'} }], {title:`Histogram: ${xCol}`, paper_bgcolor:'#fff', plot_bgcolor:'#fff'}, config); return; }
    if (type === 'bar') { Plotly.newPlot('chart-custom', [{ x, y, type:'bar', marker:{color:'#7c3aed'} }], {title:`Bar: ${yCol} by ${xCol}`, paper_bgcolor:'#fff', plot_bgcolor:'#fff'}, config); return; }
    if (type === 'line') { Plotly.newPlot('chart-custom', [{ x, y, mode:'lines+markers', line:{color:'#7c3aed'} }], {title:`Line: ${yCol} vs ${xCol}`, paper_bgcolor:'#fff', plot_bgcolor:'#fff'}, config); return; }
    Plotly.newPlot('chart-custom', [{ x, y, mode:'markers', marker:{color:'#7c3aed'} }], {title:`Scatter: ${yCol} vs ${xCol}`, paper_bgcolor:'#fff', plot_bgcolor:'#fff'}, config);
  };

  [customX, customY, customType, customRender].forEach(el => { el?.addEventListener('change', renderCustomChart); el?.addEventListener('click', renderCustomChart); });

  uploadForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = new FormData(uploadForm);
    try { const res = await fetch('/upload', { method:'POST', body: formData }); const data = await res.json(); if (data.status === 'success') { showMessage(`Upload complete. Rows in master: ${data.rows_in_master}`, 'success'); loadEDARaw(); loadEDAEngineered(); fetchMasterFull(); renderImages(data.plots || []); } else { showMessage(data.message || 'Upload failed', 'danger'); } } catch { showMessage('Upload request failed', 'danger'); }
  });

  processBtn?.addEventListener('click', async () => {
    try { const res = await fetch('/api/process', { method:'POST' }); const data = await res.json(); if (data.status === 'success') { showMessage('Processing completed and visualizations regenerated.', 'success'); loadEDARaw(); loadEDAEngineered(); fetchMasterFull(); renderImages(data.plots || []); } else { showMessage(data.message || 'Processing failed', 'danger'); } } catch { showMessage('Processing request failed', 'danger'); }
  });

  resetBtn?.addEventListener('click', async () => {
    try { const res = await fetch('/reset', { method:'POST' }); const data = await res.json(); if (data.status === 'success') { showMessage('Data reset completed.', 'success'); edaTableRaw.innerHTML = ''; edaStatusRaw.textContent = 'No data available.'; edaTableEng.innerHTML = ''; edaStatusEng.textContent = 'No data available.'; fullRecords = []; fullColumns = []; renderCustomChart(); images.innerHTML = ''; } else { showMessage('Reset failed', 'danger'); } } catch { showMessage('Reset request failed', 'danger'); }
  });

  const renderImages = (paths) => {
    images.innerHTML = paths.map(p => {
      const name = (p.split('/').pop() || 'image');
      return `<div class="image-item"><img src="${p}" alt="${name}" /><div><a class="btn btn-outline" href="${p}" download>Download</a></div></div>`;
    }).join('');
  };

  loadEDARaw();
  loadEDAEngineered();
  fetchMasterFull();
  </script>
</body>
</html>
